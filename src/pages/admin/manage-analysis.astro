---
import { protectAdminPage } from "../../lib/adminSecurity";
import "../../styles/global.css";

// Proteger p√°gina de administraci√≥n
const user = protectAdminPage(Astro.request);

// P√°gina para gestionar an√°lisis existentes
import { getAnalisis } from "../../lib/mongo";

let analysis: any[] = [];
let error = "";

try {
  // Obtener todos los an√°lisis, incluyendo borradores
  analysis = await getAnalisis();
} catch (err) {
  error = "Error cargando an√°lisis";
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestionar An√°lisis - Admin SeriesGuide</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">Gestionar An√°lisis</h1>
          <p class="text-gray-400 text-sm sm:text-base">
            Edita, elimina y administra los an√°lisis existentes
          </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 w-full sm:w-auto">
          <a
            href="/admin/add-analysis"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-center"
          >
            + Nuevo An√°lisis
          </a>
          <a
            href="/admin"
            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-center"
          >
            ‚Üê Volver
          </a>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg border border-gray-700">
          <h3 class="text-xs sm:text-sm font-medium text-gray-400 mb-2">Total An√°lisis</h3>
          <p class="text-2xl sm:text-3xl font-bold text-white">{analysis.length}</p>
        </div>
        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg border border-gray-700">
          <h3 class="text-xs sm:text-sm font-medium text-gray-400 mb-2">Publicados</h3>
          <p class="text-2xl sm:text-3xl font-bold text-green-400">
            {analysis.filter((a) => a.status === "published").length}
          </p>
        </div>
        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg border border-gray-700">
          <h3 class="text-xs sm:text-sm font-medium text-gray-400 mb-2">Borradores</h3>
          <p class="text-2xl sm:text-3xl font-bold text-yellow-400">
            {analysis.filter((a) => a.status === "draft").length}
          </p>
        </div>
        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg border border-gray-700">
          <h3 class="text-xs sm:text-sm font-medium text-gray-400 mb-2">Total Vistas</h3>
          <p class="text-2xl sm:text-3xl font-bold text-blue-400">
            {analysis.reduce((sum, a) => sum + (a.views || 0), 0)}
          </p>
        </div>
      </div>

      <!-- Buscador -->
      <div class="mb-6">
        <input
          type="text"
          id="search"
          placeholder="Buscar an√°lisis por t√≠tulo, contenido, tags..."
          class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 border border-gray-700 focus:border-blue-500 focus:outline-none"
        />
      </div>

      <!-- Lista de An√°lisis -->
      {
        error ? (
          <div class="bg-red-500 text-white p-4 rounded-lg mb-6">{error}</div>
        ) : (
          <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <!-- Vista de escritorio -->
            <div class="hidden md:block overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                      An√°lisis
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                      Estado
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                      Fecha
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                      Vistas
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                      Likes
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-700" id="analysisTable">
                  {analysis.map((analisis) => (
                    <tr
                      class="hover:bg-gray-700 transition-colors analysis-row"
                      data-analysis={JSON.stringify(analisis)}
                    >
                      <td class="px-6 py-4">
                        <div>
                          <div class="text-sm font-medium text-white">
                            {analisis.title}
                          </div>
                          <div class="text-sm text-gray-400">
                            {analisis.excerpt
                              ? analisis.excerpt.substring(0, 100) + "..."
                              : "Sin extracto"}
                          </div>
                          <div class="flex flex-wrap gap-1 mt-1">
                            {analisis.tags &&
                              analisis.tags
                                .slice(0, 3)
                                .map((tag: string) => (
                                  <span class="bg-blue-900 text-blue-200 px-2 py-1 text-xs rounded">
                                    {tag}
                                  </span>
                                ))}
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            analisis.status === "published"
                              ? "bg-green-900 text-green-200"
                              : "bg-yellow-900 text-yellow-200"
                          }`}
                        >
                          {analisis.status === "published"
                            ? "Publicado"
                            : "Borrador"}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {new Date(analisis.createdAt).toLocaleDateString(
                          "es-ES"
                        )}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {analisis.views || 0}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {analisis.likes || 0}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex space-x-2">
                          <button
                            data-action="edit"
                            data-id={analisis._id}
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors"
                          >
                            Editar
                          </button>
                          <button
                            data-action="delete"
                            data-id={analisis._id}
                            data-title={analisis.title}
                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors"
                          >
                            Eliminar
                          </button>
                          <a
                            href={`/analisis/${analisis.slug}`}
                            target="_blank"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors"
                          >
                            Ver
                          </a>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <!-- Vista m√≥vil -->
            <div class="md:hidden divide-y divide-gray-700" id="analysisTableMobile">
              {analysis.map((analisis) => (
                <div
                  class="p-4 analysis-row"
                  data-analysis={JSON.stringify(analisis)}
                >
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                      <h3 class="text-white font-medium text-sm leading-tight">
                        {analisis.title}
                      </h3>
                      <p class="text-gray-400 text-xs mt-1">
                        {analisis.excerpt
                          ? analisis.excerpt.substring(0, 80) + "..."
                          : "Sin extracto"}
                      </p>
                    </div>
                    <span
                      class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ml-3 ${
                        analisis.status === "published"
                          ? "bg-green-900 text-green-200"
                          : "bg-yellow-900 text-yellow-200"
                      }`}
                    >
                      {analisis.status === "published"
                        ? "Publicado"
                        : "Borrador"}
                    </span>
                  </div>
                  
                  <div class="flex justify-between items-center text-xs text-gray-400 mb-3">
                    <span>
                      {new Date(analisis.createdAt).toLocaleDateString("es-ES")}
                    </span>
                    <div class="flex gap-3">
                      <span>üëÅ {analisis.views || 0}</span>
                      <span>‚ù§Ô∏è {analisis.likes || 0}</span>
                    </div>
                  </div>
                  
                  <div class="flex flex-wrap gap-1 mb-3">
                    {analisis.tags &&
                      analisis.tags
                        .slice(0, 2)
                        .map((tag: string) => (
                          <span class="bg-blue-900 text-blue-200 px-2 py-1 text-xs rounded">
                            {tag}
                          </span>
                        ))}
                  </div>
                  
                  <div class="flex gap-2">
                    <button
                      data-action="edit"
                      data-id={analisis._id}
                      class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-xs font-medium transition-colors"
                    >
                      Editar
                    </button>
                    <button
                      data-action="delete"
                      data-id={analisis._id}
                      data-title={analisis.title}
                      class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-xs font-medium transition-colors"
                    >
                      Eliminar
                    </button>
                    <a
                      href={`/analisis/${analisis.slug}`}
                      target="_blank"
                      class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs font-medium transition-colors text-center"
                    >
                      Ver
                    </a>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      }
    </div>

    <script is:inline>
      // Event delegation para los botones
      document.addEventListener("click", function (e) {
        const target = e.target;
        if (target && target.dataset) {
          if (target.dataset.action === "edit") {
            editAnalysis(target.dataset.id);
          } else if (target.dataset.action === "delete") {
            deleteAnalysis(target.dataset.id, target.dataset.title);
          }
        }
      });

      // B√∫squeda en tiempo real
      const searchInput = document.getElementById("search");
      if (searchInput) {
        searchInput.addEventListener("input", function (e) {
          const target = e.target;
          if (target && target.value !== undefined) {
            const searchTerm = target.value.toLowerCase();
            const rows = document.querySelectorAll(".analysis-row");

            rows.forEach((row) => {
              try {
                const analysisData = JSON.parse(row.dataset.analysis || "{}");
                const searchText =
                  `${analysisData.title || ""} ${analysisData.content || ""} ${(analysisData.tags || []).join(" ")} ${analysisData.excerpt || ""}`.toLowerCase();

                if (searchText.includes(searchTerm)) {
                  row.style.display = "";
                } else {
                  row.style.display = "none";
                }
              } catch (error) {
                console.error("Error parsing analysis data:", error);
              }
            });
          }
        });
      }

      function editAnalysis(id) {
        if (!id) {
          alert("Error: ID de an√°lisis no v√°lido");
          return;
        }
        // Redirigir a la p√°gina de edici√≥n
        window.location.href = `/admin/edit-analysis?id=${id}`;
      }

      function deleteAnalysis(id, title) {
        if (!id) {
          alert("Error: ID de an√°lisis no v√°lido");
          return;
        }

        if (
          !confirm(
            `¬øEst√°s seguro de que quieres eliminar el an√°lisis "${title || "Sin t√≠tulo"}"? Esta acci√≥n no se puede deshacer.`
          )
        ) {
          return;
        }

        fetch("/api/analysis", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert("An√°lisis eliminado exitosamente");
              location.reload();
            } else {
              alert(
                "Error eliminando el an√°lisis: " +
                  (data.error || "Error desconocido")
              );
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error eliminando el an√°lisis: " + error.message);
          });
      }
    </script>
  </body>
</html>
